name: Block Kustomization in nn-id-dev cluster

on:
  pull_request:
    # Trigger untuk semua PR (tidak dibatasi paths agar tidak silent-fail)
    # Filter file akan dilakukan di dalam script
    types: [opened, synchronize, reopened]
  push:
    paths:
      - 'flux/clusters/nn-id-dev/**'

jobs:
  block-kustomization-file:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Untuk memastikan semua history tersedia

      - name: Debug info
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Base ref: ${{ github.base_ref }}"
          echo "Head ref: ${{ github.head_ref }}"
          git log --oneline -n 3

      - name: Check for forbidden kustomization file in pull request
        if: github.event_name == 'pull_request'
        run: |
          echo "üîç Checking files in PR..."
          git fetch origin ${{ github.base_ref }} --depth=1

          git diff --name-only origin/${{ github.base_ref }}..HEAD | tee changed_files.txt

          echo "üìÑ Files changed:"
          cat -v changed_files.txt

          # Gunakan grep -a dan LC_ALL=C agar path dengan karakter aneh bisa dibaca
          if LC_ALL=C grep -a -iE "^flux/clusters/nn-id-dev/.*/?kustomization\.ya?ml$" changed_files.txt; then
            echo "‚ùå Error: Adding or modifying a kustomization file in flux/clusters/nn-id-dev is not allowed."
            exit 1
          else
            echo "‚úÖ No forbidden kustomization file detected."
          fi

      - name: Check for forbidden kustomization file in push
        if: github.event_name == 'push'
        run: |
          echo "üîç Checking files in push..."
          git diff-tree --no-commit-id --name-status -r ${{ github.sha }}

          if git diff-tree --no-commit-id --name-status -r ${{ github.sha }} | grep -iE "^[AM]\s+flux/clusters/nn-id-dev/.*/?kustomization\.ya?ml$"; then
            echo "‚ùå Error: Adding or modifying a kustomization file in flux/clusters/nn-id-dev is not allowed."
            exit 1
          else
            echo "‚úÖ No forbidden kustomization file detected."
          fi
